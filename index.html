<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Contador de votos presidenciales 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      max-width: 600px;
      margin: auto;
      background-color: #f5f5f5;
    }
    h1 {
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
    }
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 1rem 0;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      padding: 0.7rem 1rem;
      font-size: 1rem;
      flex: 1 1 45%;
      min-width: 100px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
    }

    button:hover {
      filter: brightness(0.85);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.4rem;
      text-align: left;
    }
    .total {
      margin-top: 1rem;
      font-weight: bold;
      font-size: 1.1rem;
    }
    .undo {
      background-color: #ff6666;
      color: white;
      width: 100%;
      margin-top: 0.5rem;
      padding: 0.7rem;
      border: none;
    }

    .undo:hover {
      background-color: #e55555;
    }

    .reset {
      background-color: #444;
      color: white;
      margin-top: 0.5rem;
      padding: 0.7rem;
      border: none;
      flex: 3;
    }

    .reset:hover {
      background-color: #555;
    }

    .settings {
      background-color: #666;
      color: white;
      margin-top: 0.5rem;
      padding: 0.7rem;
      border: none;
      flex: 1;
    }

    .settings:hover {
      background-color: #777;
    }

    .button-row {
      display: flex;
      gap: 0.5rem;
      justify-content: space-between;
    }
  </style>
</head>
<body>

  <h1>Contador de votos presidenciales 2025</h1>

  <p>
    <b>Antes de empezar el conteo real</b>, asegúrese de presionar
    <i>“Reiniciar conteo”</i> para dejar todo en cero.
  </p>

  <div class="buttons" id="buttons-container">
    <!-- Los botones se generarán dinámicamente con JavaScript -->
  </div>

  <button class="undo" onclick="undoLast()">Deshacer último voto</button>

  <div class="button-row">
    <button class="settings" onclick="window.location.href='settings.html'">Menú</button>
    <button class="reset" onclick="resetAll()">Reiniciar conteo</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Candidato</th>
        <th>Votos</th>
      </tr>
    </thead>
    <tbody id="table-body">
      <!-- Las filas se generarán dinámicamente con JavaScript -->
    </tbody>
  </table>

  <div class="total">
    Total: <span id="total_vt">0</span>
  </div>

  <script>
    const STORAGE_KEY = "contador_votos_2v";
    const OPTIONS_KEY = "contador_votos_opciones_2v";

    // Opciones por defecto
    const defaultOptions = {
      jara: 'Jara',
      kast: 'Kast',
      nulo: 'Nulo',
      blanco: 'Blanco'
    };

    // Cargar opciones desde localStorage o usar por defecto
    let opciones = {};
    function loadOptions() {
      try {
        const saved = localStorage.getItem(OPTIONS_KEY);
        if (saved) {
          opciones = JSON.parse(saved);
        } else {
          opciones = {...defaultOptions};
          saveOptions();
        }
      } catch (e) {
        console.warn("Error cargando opciones:", e);
        opciones = {...defaultOptions};
      }
    }

    function saveOptions() {
      try {
        localStorage.setItem(OPTIONS_KEY, JSON.stringify(opciones));
      } catch (e) {
        console.warn("No se pudo guardar las opciones:", e);
      }
    }

    loadOptions();

    const votes = {};
    Object.keys(opciones).forEach(key => {
      votes[key] = 0;
    });

    const history = [];

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;

        const data = JSON.parse(raw);

        if (data.votes) {
          for (const key in votes) {
            if (Object.prototype.hasOwnProperty.call(data.votes, key)) {
              votes[key] = data.votes[key];
            }
          }
        }

        if (Array.isArray(data.history)) {
          history.splice(0, history.length, ...data.history);
        }
      } catch (e) {
        console.warn("No se pudo cargar el estado guardado:", e);
      }
    }

    function saveState() {
      const data = {
        votes: votes,
        history: history
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.warn("No se pudo guardar el estado:", e);
      }
    }

    function generateButtons() {
      const container = document.getElementById('buttons-container');
      container.innerHTML = '';

      for (const key in opciones) {
        const button = document.createElement('button');
        button.textContent = opciones[key];
        button.onclick = () => addVote(key);
        container.appendChild(button);
      }
    }

    function generateTableRows() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';

      for (const key in opciones) {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${opciones[key]}</td><td id="${key}_vt">0</td>`;
        tbody.appendChild(row);
      }
    }

    function updateDisplay() {
      let total = 0;

      for (const key in votes) {
        total += votes[key];
        const cell = document.getElementById(key + "_vt");
        if (cell) {
          cell.textContent = votes[key];
        }
      }

      document.getElementById("total_vt").textContent = total;
    }

    function addVote(key) {
      if (!(key in votes)) {
        alert("Candidato desconocido: " + key);
        return;
      }
      votes[key] += 1;
      history.push(key);
      updateDisplay();
      saveState();
    }

    function undoLast() {
      if (history.length === 0) {
        alert("No hay votos para deshacer.");
        return;
      }

      const last = history.pop();
      votes[last] -= 1;
      updateDisplay();
      saveState();
    }

    function resetAll() {
      const ok = confirm(
        "¿Seguro que quieres reiniciar todos los votos?\n" +
        "Esta acción no se puede deshacer."
      );
      if (!ok) return;

      // Poner todos los votos en 0
      for (const key in votes) {
        votes[key] = 0;
      }

      // Vaciar historial
      history.splice(0, history.length);

      updateDisplay();
      saveState();
    }

    // Al cargar la página:
    loadState();
    generateButtons();
    generateTableRows();
    updateDisplay();
  </script>

</body>
</html>